<html>
<head>
<title>LOV-ES</title>
<meta charset="utf-8">
<link type="text/css" href="css/ui-lightness/jquery-ui-1.8.21.custom.css" rel="stylesheet" />
<link type="text/css" href="css/lda.css" rel="stylesheet" />
<script type="text/javascript" src="js/jquery-1.7.2.min.js"></script>
<script type="text/javascript" src="js/jquery-ui-1.8.21.custom.min.js"></script>
<script src="js/jquery.tagcanvas.min.js" type="text/javascript"></script>
<script type="text/javascript" src="js/stopwords.js"></script>
<script type="text/javascript" src="js/lda.js"></script>
<script type="text/javascript">
SPARQL = function(o) {
  this.query = function(q) {
    return $.ajax({
	url: o.endpoint,
      accepts: {json: "application/sparql-results+json"},
      data: {query: q, apikey: o.apikey},
      dataType: "json"
    });
  };
};
</script>
<script>

var wikidataendpoint = new SPARQL({ 
           apikey: "YOUR-API-KEY-HERE", 
           endpoint: "https://query.wikidata.org/sparql"
});

  var endpoint = new SPARQL({ 
           apikey: "YOUR-API-KEY-HERE", 
           endpoint: "https://lov.linkeddata.es/dataset/lov/sparql"
});

  function onSuccessMember(json) {
      // List the topic ids.
      var topicArray = Array.from(new Set(json.results.bindings.map(item => item[json.head.vars[0]].value)));
      console.log(topicArray.length);
      console.log(topicArray);

      console.log("++++++++++++++++++++++++++++++++++++++");
      
      // Count the total weights for each topic
      // Sum the weight per topic per vocabulary
      // Collect the location for each vocabulary
      var totalWeight = new Array(topicArray.length).fill(0);
      var infoArray = new Object();
      var sumOfWeightByTopic = new Object();
      for (var b in json.results.bindings) {
	  totalWeight[json.results.bindings[b][json.head.vars[0]].value] += parseInt(json.results.bindings[b][json.head.vars[2]].value) ;
	  infoArray[json.results.bindings[b][json.head.vars[3]].value] = json.results.bindings[b][json.head.vars[4]].value ;
	  if (typeof sumOfWeightByTopic[json.results.bindings[b][json.head.vars[3]].value] == 'undefined') {
	      sumOfWeightByTopic[json.results.bindings[b][json.head.vars[3]].value] = new Array(topicArray.length).fill(0) ;
	  }
	  sumOfWeightByTopic[json.results.bindings[b][json.head.vars[3]].value][json.results.bindings[b][json.head.vars[0]].value] += parseInt(json.results.bindings[b][json.head.vars[2]].value);
      }
      console.log(totalWeight);
      // Aggregated the weights (sum per topic) for each vocabulary
      var aggregatedWeight = new Object();
      for (var key in sumOfWeightByTopic) {
	  aggregatedWeight[key] = 0 ;
	  for (var topic in topicArray) {
	      aggregatedWeight[key] += sumOfWeightByTopic[key][topic]/totalWeight[topic];
	  }
      }
      // Sorting the voc by their aggregatedWeight
      let sortable = [];
      for (var voc in aggregatedWeight) {
	  sortable.push([voc, aggregatedWeight[voc]]);
      }
      var sortedResults=sortable.sort(function (a,b) { return b[1] - a[1]; });
      console.log(sortedResults);
      console.log("=========================================");

  
      // HTML rendering of the computed results.
      var html = "<table border='1' id='t01'>";
      //html += "<tr>";
      html += "<thead><tr><th>Score</th><th>Vocabulary<br>[Location]</th></tr></thead>";
      html += "<tbody>";
      for (var voc in sortedResults) {
	  html += "<tr><td>"+Math.floor(sortedResults[voc][1]*100)+"</td><td>"+sortedResults[voc][0]+"<br>["+infoArray[sortedResults[voc][0]]+"]</td></tr>";
      }
      html += "</tbody>";
      html += "</table>";
      document.getElementById("result-member").innerHTML = html;
      
  }

  
function topicise() {
	var documents = new Array();
	var f = {};
	var vocab=new Array();
	var docCount=0;
	for(var i=0;i<sentences.length;i++) {
		if (sentences[i]=="") continue;
		var words = sentences[i].split(/[\s,\"]+/);
		if(!words) continue;
		var wordIndices = new Array();
		for(var wc=0;wc<words.length;wc++) {
			var w=words[wc].toLowerCase().replace(/[^a-z\'A-Z0-9 ]+/g, '');
			//TODO: Add stemming
			if (w=="" || w.length==1 || stopwords[w] || w.indexOf("http")==0) continue;
			if (f[w]) { 
				f[w]=f[w]+1;			
			} 
			else if(w) { 
				f[w]=1; 
				vocab.push(w); 
			};	
			wordIndices.push(vocab.indexOf(w));
		}
		if (wordIndices && wordIndices.length>0) {
			documents[docCount++] = wordIndices;
		}
	}
		
	var V = vocab.length;
	var M = documents.length;
	var K = parseInt($( "#topics" ).val());
	var alpha = 0.1;  // per-document distributions over topics
	var beta = .01;  // per-topic distributions over words

	lda.configure(documents,V,10000, 2000, 100, 10);
	lda.gibbs(K, alpha, beta);

	var theta = lda.getTheta();
	var phi = lda.getPhi();

	var text = '';

	//topics
	var topTerms=20;
        var topicText = new Array();
        var queryValues = new Array();
	for (var k = 0; k < phi.length; k++) {
		text+='<canvas id="topic'+k+'" class="topicbox color'+k+'"><ul>';
		var tuples = new Array();
		for (var w = 0; w < phi[k].length; w++) {
			 tuples.push(""+phi[k][w].toPrecision(2)+"_"+vocab[w]);
		}
		tuples.sort().reverse();
		if(topTerms>vocab.length) topTerms=vocab.length;
	    topicText[k]='';
	    queryValues[k]=''; // This contains 3-tuples: (topicId word weight)
		for (var t = 0; t < topTerms; t++) {
			var topicTerm=tuples[t].split("_")[1];
			var prob=parseInt(tuples[t].split("_")[0]*100);
			if (prob<0.0001) continue;
			text+=( '<li><a href="javascript:void(0);" data-weight="'+(prob)+'" title="'+prob+'%">'+topicTerm +'</a></li>' );			
			//console.log("topic "+k+": "+ topicTerm+" = " + prob  + "%");
		        topicText[k] += ( topicTerm +" ");
		        queryValues[k] += ( "(\"" + k + "\" \"" + topicTerm + "\" \"" + prob + "\") ");
		}
		text+='</ul></canvas>';
	}
	$('#topiccloud').html(text);

    var sortedResults = [];
    var query="SELECT distinct ?topicid ?word ?weight ?voc ?location WHERE { values (?topicid ?word ?weight) { ";
    for (var v=0; v<queryValues.length; v++){
	query += queryValues[v] + " ";
    }
    query += " } ?voc a <http://purl.org/vocommons/voaf#Vocabulary> . ?voc <http://purl.org/dc/terms/description> ?description . ?voc <http://www.w3.org/ns/dcat#distribution> ?location . filter ( contains ( str(?description),?word))}";
    console.log(query);
    endpoint.query(query).done(onSuccessMember);
    //var results=endpoint.query(query);
    //results.done(onSuccessMember); // To print the table
    //sortedResults = [].concat(sortedResults,results.done(sortTopic));
    //var resultsss=results.done(sortTopic);
    //console.log(resultsss);
    //for (var key in resultsss) {
    //    console.log(key + " = " + resultsss[key] + '');
    //}


    
	text='<div class="spacer"> </div>';
	//highlight sentences	
	for (var m = 0; m < theta.length; m++) {
		text+='<div class="lines">';
		text+='<div style="display:table-cell;width:100px;padding-right:5px">';
		for (var k = 0; k < theta[m].length; k++) {
			text+=('<div class="box bgcolor'+k+'" style="width:'+parseInt(""+(theta[m][k]*100))+'px" title="'+topicText[k]+'"></div>');
		}
		text+='</div>'+sentences[m]+'</div>';
	}
	$("#output").html(text);
	
	for (var k = 0; k < phi.length; k++) {
		if(!$('#topic'+k).tagcanvas({
		      textColour: $('#topic'+k).css('color'),
			  maxSpeed: 0.05,
			 initial: [(Math.random()>0.5 ? 1: -1) *Math.random()/2,(Math.random()>0.5 ? 1: -1) *Math.random()/2],  //[0.1,-0.1],
			  decel: 0.98,
			  reverse: true,
			  weightSize:10,
			  weightMode:'size',
			  weightFrom:'data-weight',
			  weight: true
			}))	
		{
			$('#topic'+k).hide();
		} else {
			//TagCanvas.Start('topic'+k);
		}
	}
}

function sleep(delay) {
    var start = new Date().getTime();
    while (new Date().getTime() < start + delay);
}
  
$(document).ready(function(){
	var select = $( "#topics" );
	var slider = $( "<div id='slider'></div>" ).insertAfter( select ).slider({
		min: 2,
		max: 10,
		range: "min",
		value: select[0].selectedIndex+2,
		slide: function( event, ui ) {
			select[0].selectedIndex = ui.value-2;
		}
	});
	$( "#topics" ).change(function() {
		slider.slider( "value", this.selectedIndex + 2 );
	});
});

function btnTopiciseClicked() {
	$('#btnTopicise').attr('disabled','disabled');
	sentences = $('#text').val().split("\n");
	topicise();
	$('#btnTopicise').removeAttr('disabled');

	
}

var sentences;
</script>

    <style>
	body {
	    margin: 20px 50px;
	}

	p {
	    margin: 20px 20px;
	    text-align: justify;
	    text-justify: inter-word;
	}

	code {
	    background: #F1F1F1;
	}

	a:link,
	a:visited {
	    color: blue;
	    background-color: transparent;
	    text-decoration: none;
	}

	a:hover {
	    color: red;
	    background-color: transparent;
	    text-decoration: underline;
	}

	.header {
	    border-radius: 15px;
	    padding: 20px;
	    text-align: center;
	    background-color: rgb(75, 125, 190);
	    color: white;
	}

	.column {
	    float: left;
	}

	/* Middle column */
	.column.middle {
	    width: 25%;
	}

	/* Left column */
	.column.left {
	    width: 30%;
	}

	/* Right column */
	.column.right {
	    width: 45%;
	}

	/* Responsive layout - makes the three columns stack on top of each other instead of next to each other */
	@media screen and (max-width: 600px) {
	    .column.left,
	    .column.middle,
	    .column.right {
		width: 100%;
	    }
	}

	.row:after {
	    content: "";
	    display: table;
	    clear: both;
	}

	.page-header {
	    border-radius: 6px;
	    padding: 5px 15px;
	    margin-top: 10px;
	    margin-bottom: 10px;
	    margin-right: 10px;
	}

	h1.page-header {
	    background-color: rgb(75, 125, 190);
	    color: white;
	}

	h2.page-header {
	    background-color: rgb(218, 229, 241);
	}

	h3.page-header {
	    background-color: rgb(238, 238, 238);
	}

	.footer {
	    background-color: #F1F1F1;
	    text-align: center;
	    padding: 10px;
	}

	table {
	    width: 98%;
	    margin-left: auto;
	    margin-right: auto;
	}

	table,
	th,
	td {
	    border: 1px solid black;
	    border-collapse: collapse;
	}

	th,
	td {
	    padding: 5px;
	    text-align: left;
	}

	table#t01 tr:nth-child(even) {
	    background-color: rgb(238, 238, 238);
	}

	table#t01 tr:nth-child(odd) {
	    background-color: transparent;
	}

	table#t01 th {
	    background-color: rgb(218, 229, 241);
	    color: black;
	}
    </style>

</head>


<body>

    <div class="header">
      <h1>LOV-ES</h1>
      <h2>~Guessing potential RDF vocabularies from natural language texts using LDA~</h2>
    </div>

    <div class="row">
      <div class="column left">
	<h2 class="page-header">Text to be structured</h2>
	<textarea id="text" cols="50" rows="30" >
Susan Golden and her husband Gary, of Nassau County, have been missing their luggage for nearly two weeks.
Their bags — with Apple AirTag tracking devices — sit with hundreds of others at Paris Charles de Gaulle Airport. The couple got on an Air France connecting flight to JFK Airport on July 1 but their luggage did not. 
"How are they allowed to continue to fly every day and more luggage is piling up?" she said.
A Facebook group has over 100 other members also missing their baggage. 
The airline posted an apology on its website. In a statement to Fox 5, a spokesperson cited a strike by some airport workers in charge of baggage handling and said the airline is working to make sure the situation rapidly returns to normal
This is hardly the only issue plaguing air travel these days.
"It's all over staffing — whether it's pilots, flight attendants, baggage handlers to keep up with the demand," said Clint Henderson, the managing editor for news at The Points Guy.
Travel experts say the meltdown is due to staff shortages coupled with more people traveling this summer after being pent-up during the COVID-19 pandemic. The experts offer some advice.
"You only want to have a carry-on with you," Frommer's Guidebooks editorial director Pauline Frommer said. "You want to fly on the first flight of the day — that way you know the plane you're flying on, and your crew, was at the airport overnight."
Just under 700,000 bags were mishandled in the first quarter of this year, according to data from Air Travel Consumer Reports. Break it down, and that's roughly seven out of every 1,000 bags. 
But the Goldens say their bags aren't lost; they're being held hostage.
"Our bags are bargaining chips between the union workers and airport to negotiate a contract," Gary said.
Air France said all baggage is expected to be delivered in the coming days.
If flying with just a carry-on isn't for you, don't check your bag more than three hours before takeoff to avoid your luggage going into a holding area. Now more so than ever before, be sure to pack your patience.
	</textarea><br/>
	<div id="menu">
	  <label for="topics">Topics:</label>
	  <select name="topics" id="topics">
	    <option>2</option>
	    <option selected="selected">3</option>
	    <option>4</option>
	    <option>5</option>
	    <option>6</option>
	    <option>7</option>
	    <option>8</option>
	    <option>9</option>
	    <option>10</option>
	  </select><br/><input id="btnTopicise" type="button" onclick="btnTopiciseClicked();" value="Analyse"/><br/>
	</div>

	
      </div>
      
      <div class="column middle">
	<h2 class="page-header">Topics using LDA</h2>


	<div class="spacer"> </div>
	<div id="topiccloud"></div>
	<br/>
	<div id="output">
	</div>
	
      </div>

      <div class="column right">
	<h2 class="page-header">Candidate Vocabularies from LOV</h2>
	<div id="result-member">
	</div>
      </div>
    </div>
    
    <br/>
    <br/>

    <footer>
      <hr/>
      <div class="footer">
	Last update: July 2022
      </div>
    </footer>
  

</body>
</html>
